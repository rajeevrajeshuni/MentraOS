# Single-stage build with Bun
FROM oven/bun:latest

# Install ca-certificates for SSL/TLS connections
RUN apt-get update && apt-get install -y ca-certificates && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy source code
COPY . .

# Install dependencies and ensure correct bun-types version
RUN bun install && \
    rm -rf node_modules/@types/bun && \
    bun add -d bun-types@1.0.17

# Build packages in sequence
RUN echo "ğŸš€ Starting build process..." && \
    echo "âš™ï¸ Building packages/sdk..." && \
    cd packages/sdk && bun run build && \
    echo "âœ… Building packages/sdk..." && \
    # echo "âš™ï¸ Building packages/utils..." && \
    # cd ../utils && bun run build && \
    # echo "âœ… Building packages/utils..." && \
    # echo "âš™ï¸ Building packages/agents..." && \
    # cd ../agents && bun run build && \
    # echo "âœ… Building packages/agents..." && \
    echo "âš™ï¸ Building packages/cloud..." && \
    cd ../cloud && bun run build && \
    echo "âœ… Building packages/cloud..." && \
    echo "ğŸ‰ğŸ‰ğŸ‰ All packages built successfully! ğŸ‰ğŸ‰ğŸ‰"

# Skip running tests in CI for now
RUN echo "âš ï¸ Skipping tests in CI build"

# Use Bun to run the application
ENV NODE_ENV=production
CMD ["echo", "Ready to run services"]
